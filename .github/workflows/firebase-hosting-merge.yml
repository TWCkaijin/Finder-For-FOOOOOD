# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    environment:
      name: FIREBASE
      url: ${{ steps.deploy.outputs.details_url }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
          cache-dependency-path: "client/pnpm-lock.yaml"

      - name: Build Client
        run: |
          cd client
          # Restore Client .env.production (Vite priorities .env.production in build)
          echo "${{ secrets.CLIENT_ENV }}" > .env.production

          pnpm install --frozen-lockfile
          pnpm run build

      - uses: FirebaseExtended/action-hosting-deploy@v0
        id: deploy
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_FINDER_FOR_FOOOOOD }}
          channelId: live
          projectId: finder-for-foooood
          entryPoint: ./client

      - name: Deploy Server Functions
        env:
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/service-account.json
        run: |
          # 1. Setup Auth
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_FINDER_FOR_FOOOOOD }}' > /tmp/service-account.json

          # 2. Setup Server
          cd server
          pnpm install --frozen-lockfile

          # 3. Restore Server .env
          echo "${{ secrets.SERVER_ENV }}" > .env

          # 4. Install Firebase Tools
          pnpm add -g firebase-tools

          # 5. Deploy using our script
          # Use 'pnpm exec' or rely on global install. 
          # The script uses 'firebase deploy'. We need to make sure 'firebase' is in path.
          # pnpm add -g puts it in pnpm global bin?
          # Let's try running via npx to be safe if global install is flaky in actions.
          # Actually, the script `deploy-with-env.ts` calls `execSync('firebase ...')`.
          # We can alias firebase to npx firebase-tools?
          # Or just install it locally in server package.

          pnpm add -D firebase-tools

          # Modify the script execution to use local binary?
          # No, 'firebase' command is expected in shell.
          # Let's add it to PATH or use npx.
          # Creating an alias/wrapper:
          echo '#!/bin/bash' > firebase
          echo 'npx firebase-tools "$@"' >> firebase
          chmod +x firebase
          export PATH=$PWD:$PATH

          pnpm run deploy:env
